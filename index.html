<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <title>Archive v6.5 (Red Dot Logic Fix)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #050505;
            --surface-color: #111111;
            --matte-bar: #161616;
            --border-color: #262626;
            --text-primary: #ffffff;
            --text-secondary: #dcdcdc;
            --text-meta: #b0b0b0;
            --brand-red: #d32f2f;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --gallery-cols: 3;
        }

        body.light-theme {
            --bg-color: #ffffff;
            --surface-color: #f9f9f9;
            --matte-bar: #f0f0f0;
            --border-color: #e0e0e0;
            --text-primary: #111111;
            --text-secondary: #333333;
            --text-meta: #555555;
        }

        /* --- LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        html, body {
            height: 100%; width: 100%; overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            font-size: 14px;
        }

        #app { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; overflow: hidden; }

        /* --- HEADER --- */
        header {
            height: calc(50px + var(--safe-top));
            padding: var(--safe-top) 16px 0 16px;
            background-color: var(--bg-color);
            z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .app-brand { font-size: 1.3rem; font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; line-height: 1; }
        .icon-theme { width: 18px; height: 18px; fill: var(--text-primary); cursor: pointer; }

        /* --- TOOLBAR --- */
        #toolbar {
            background: var(--bg-color); padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex; gap: 10px; align-items: center;
            flex-shrink: 0; z-index: 90;
        }
        .search-wrapper {
            flex: 1; min-width: 0; display: flex; align-items: center;
            background: var(--surface-color); border: 1px solid var(--border-color);
            border-radius: 4px; height: 36px;
        }
        .search-icon { width: 16px; height: 16px; fill: var(--text-meta); margin-left: 10px; flex-shrink: 0; }
        #filter-input {
            flex: 1; background: transparent; border: none;
            color: var(--text-primary); font-size: 0.9rem; padding: 0 10px; height: 100%; min-width: 0;
        }
        .btn-clear { width: 30px; height: 100%; background: transparent; border: none; color: var(--text-meta); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .gallery-pill {
            display: flex; align-items: center; background: var(--surface-color);
            border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; height: 36px;
        }
        .gallery-btn {
            background: transparent; border: none; color: var(--text-primary); width: 32px; height: 100%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1rem;
        }
        .gallery-btn:active { background: var(--border-color); }
        .gallery-val {
            font-size: 0.8rem; font-weight: 600; color: var(--text-primary); width: 24px;
            border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color);
            height: 100%; display: flex; align-items: center; justify-content: center; font-family: monospace;
        }

        /* --- SCROLL AREA --- */
        #app-content {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding-bottom: calc(70px + var(--safe-bottom));
            position: relative;
            -webkit-overflow-scrolling: touch; 
            overscroll-behavior-y: contain;
        }

        /* --- LIST VIEW --- */
        .month-header {
            position: sticky; top: 0;
            background: var(--matte-bar); padding: 3px 12px; 
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; z-index: 10; height: 28px;
        }
        .month-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
        .month-arrow { width: 9px; height: 9px; fill: var(--text-secondary); transition: transform 0.2s ease; }
        .month-content { display: block; }
        .month-group.closed .month-content { display: none; }
        .month-group.closed .month-arrow { transform: rotate(-90deg); }

        .film-row {
            display: flex; align-items: center; gap: 12px; padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color); cursor: pointer; position: relative;
        }
        .film-row:active { background: var(--surface-color); }
        .date-box { width: 24px; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; text-align: center; }
        .row-poster {
            width: 30px; height: 45px; background-color: var(--surface-color);
            background-size: cover; background-position: center; border: 1px solid var(--border-color); flex-shrink: 0;
        }
        .row-info { flex: 1; display: flex; flex-direction: column; gap: 2px; overflow: hidden; justify-content: center; }
        .row-top-line { display: flex; align-items: center; gap: 6px; font-size: 0.95rem; line-height: 1.1; white-space: nowrap; overflow: hidden; }
        .row-title { font-weight: 600; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .row-extras { font-size: 0.8rem; color: var(--text-secondary); opacity: 0.7; font-weight: 400; flex-shrink: 0; }
        .icon-rewatch { width: 14px; height: 14px; fill: var(--text-secondary); opacity: 0.8; flex-shrink: 0; }
        .row-meta { font-size: 0.75rem; color: var(--text-meta); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 400; }
        .row-rating { font-size: 0.85rem; font-weight: 600; min-width: 25px; text-align: right; }

        /* WARNING DOT CSS */
        .warning-dot {
            width: 7px; height: 7px; 
            background-color: var(--brand-red);
            border-radius: 50%;
            display: inline-block;
            margin-left: 6px;
            flex-shrink: 0;
            box-shadow: 0 0 2px var(--brand-red);
            border: 1px solid rgba(0,0,0,0.3); /* Pop against dark */
        }
        /* Gallery Dot Position */
        .gallery-item .warning-dot {
            position: absolute; top: 4px; right: 4px;
            margin: 0;
            border: 1px solid rgba(0,0,0,0.8);
            z-index: 2;
            width: 8px; height: 8px; /* Slightly larger in gallery */
        }

        /* --- GALLERY VIEW --- */
        .gallery-grid {
            display: grid; grid-template-columns: repeat(var(--gallery-cols), 1fr);
            gap: 1px; background: var(--bg-color);
            transition: grid-template-columns 0.2s ease;
        }
        .gallery-item {
            aspect-ratio: 2/3; background: var(--surface-color);
            background-size: cover; background-position: center; cursor: pointer; position: relative;
        }
        .gallery-item.no-poster { display: flex; align-items: center; justify-content: center; padding: 5px; font-size: 0.6rem; text-align: center; color: var(--text-meta); border: 1px solid var(--border-color); }

        /* --- FAB & TABS --- */
        #add-film-btn {
            position: fixed; bottom: calc(70px + var(--safe-bottom)); right: 1.5rem;
            width: 50px; height: 50px; background: var(--text-primary); color: var(--bg-color);
            border-radius: 50%; font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 200; border: none; cursor: pointer;
        }
        .tab-bar {
            position: fixed; bottom: 0; width: 100%; height: calc(56px + var(--safe-bottom));
            background: var(--bg-color); display: flex; justify-content: space-around;
            padding-bottom: var(--safe-bottom); border-top: 1px solid var(--border-color); z-index: 90;
        }
        .tab-btn { flex: 1; background: transparent; border: none; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; }
        .tab-btn.active { color: var(--text-primary); }
        .tab-icon { width: 20px; height: 20px; fill: currentColor; margin-bottom: 4px; }
        .tab-text { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: var(--bg-color); z-index: 2000;
            display: flex; flex-direction: column; padding: calc(1rem + var(--safe-top)) 1.5rem 1.5rem;
            overflow-y: auto;
        }
        .form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .form-title { font-weight: 600; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 0.05em; }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .std-input {
            background: transparent; border: none; border-bottom: 1px solid var(--border-color);
            color: var(--text-primary); padding: 8px 0; width: 100%; font-size: 1rem; 
            font-family: 'IBM Plex Sans', sans-serif; font-weight: 500; border-radius: 0;
            transition: border-color 0.2s;
        }
        .std-input:focus { border-bottom-color: var(--text-primary); }
        
        .input-error { border-bottom: 2px solid var(--brand-red) !important; animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        .poster-select-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .poster-preview {
            width: 40px; height: 60px; background: var(--surface-color); border: 1px solid var(--border-color);
            background-size: cover; background-position: center; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--text-secondary); cursor: pointer;
        }
        .poster-preview.selected { border: 2px solid var(--text-primary); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        
        .btn-save { width: 100%; background: var(--text-primary); color: var(--bg-color); border: none; padding: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border-radius: 2px; cursor: pointer; margin-top: 2rem; }
        .btn-delete { width: 100%; background: transparent; color: var(--brand-red); border: 1px solid var(--border-color); padding: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border-radius: 2px; cursor: pointer; margin-top: 10px; }

        /* Suggestions */
        .suggestion-list { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: var(--bg-color); border: 1px solid var(--border-color); 
            max-height: 250px; overflow-y: auto; z-index: 10; margin-top:5px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .suggestion-item { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; gap: 12px; align-items: center; cursor: pointer; }
        .suggestion-item:active { background: var(--surface-color); }
        .suggestion-thumb { width: 34px; height: 50px; background: #222; background-size: cover; border:1px solid var(--border-color); flex-shrink: 0; }
        .suggestion-info { display: flex; flex-direction: column; justify-content: center; }
        .suggestion-title { font-weight: 600; font-size: 0.95rem; line-height: 1.2; color: var(--text-primary); }
        .suggestion-year { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; font-weight: 500; }

        /* Confirm Modal */
        .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4000; display: flex; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
        .confirm-box { width: 100%; max-width: 500px; background: var(--bg-color); border-top-left-radius: 12px; border-top-right-radius: 12px; padding: 24px; border-top: 1px solid var(--border-color); animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); }}
        .confirm-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; color: var(--text-primary); }
        .confirm-desc { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 24px; }
        .confirm-actions { display: flex; gap: 12px; }
        .btn-confirm { flex: 1; padding: 14px; border-radius: 4px; font-weight: 600; border: none; cursor: pointer; font-family: 'IBM Plex Sans', sans-serif; }
        .btn-cancel { background: var(--surface-color); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-danger-confirm { background: var(--brand-red); color: white; }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <span class="app-brand">ARCHIVE</span>
        <div @click="toggleTheme" style="padding:5px;">
            <svg class="icon-theme" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
        </div>
    </header>

    <div id="toolbar">
        <div class="search-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <input type="text" id="filter-input" v-model="searchQuery" placeholder="Search movies...">
            <button class="btn-clear" v-if="searchQuery" @click="searchQuery=''">×</button>
        </div>
        <div class="gallery-pill" v-if="view === 'gallery'">
            <button class="gallery-btn" @click="adjustGrid(1)">−</button>
            <div class="gallery-val">{{ galleryCols }}</div>
            <button class="gallery-btn" @click="adjustGrid(-1)">+</button>
        </div>
    </div>

    <div id="app-content" :style="{'--gallery-cols': galleryCols}">
        
        <div v-if="view === 'home'">
            <div v-for="(group, key) in groupedLibrary" :key="key" class="month-group" :class="{closed: closedGroups.includes(key)}">
                <div class="month-header" @click="toggleGroup(key)">
                    <div class="month-label">{{ group.label }}</div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:0.75rem; font-weight:700">{{ group.items.length }}</span>
                        <svg class="month-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </div>
                </div>
                <div class="month-content">
                    <div class="film-row" v-for="movie in group.items" :key="movie.id" 
                         @click="editEntry(movie)" 
                         @touchstart="startLongPress(movie)" 
                         @touchend="cancelLongPress" 
                         @touchmove="cancelLongPress">
                        <div class="date-box">{{ new Date(movie.dateWatched).getDate() }}</div>
                        <div class="row-poster" :style="{backgroundImage: 'url('+movie.poster+')'}"></div>
                        <div class="row-info">
                            <div class="row-top-line">
                                <span class="row-title">{{ movie.title }}</span>
                                <div v-if="hasMissingInfo(movie)" class="warning-dot"></div>
                                <div class="row-extras">({{ movie.year }}) • {{ movie.runtime }}</div>
                                <svg v-if="movie.rewatch" class="icon-rewatch" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                            </div>
                            <div class="row-meta">{{ movie.director }} • {{ movie.language }} • {{ movie.genre }}</div>
                        </div>
                        <div class="row-rating">{{ movie.rating }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'gallery'">
            <div v-for="(group, key) in groupedLibrary" :key="key" class="month-group" :class="{closed: closedGroups.includes(key)}">
                <div class="month-header" @click="toggleGroup(key)">
                    <div class="month-label">{{ group.label }}</div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:0.75rem; font-weight:700">{{ group.items.length }}</span>
                        <svg class="month-arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                    </div>
                </div>
                <div class="month-content gallery-grid">
                    <div class="gallery-item" v-for="movie in group.items" :key="movie.id" 
                         :style="{backgroundImage: movie.poster && movie.poster !== 'N/A' ? 'url('+getHighRes(movie.poster)+')' : ''}"
                         :class="{'no-poster': !movie.poster || movie.poster === 'N/A'}"
                         @click="editEntry(movie)">
                        <span v-if="!movie.poster || movie.poster === 'N/A'">{{ movie.title }}</span>
                        <div v-if="hasMissingInfo(movie)" class="warning-dot"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <button id="add-film-btn" v-if="view === 'home'" @click="openNewForm">+</button>

    <nav class="tab-bar">
        <button class="tab-btn" :class="{active: view === 'home'}" @click="view='home'">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg><span class="tab-text">Log</span>
        </button>
        <button class="tab-btn" :class="{active: view === 'gallery'}" @click="view='gallery'">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/></svg><span class="tab-text">Gallery</span>
        </button>
        <button class="tab-btn" @click="goToProfile">
            <svg class="tab-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span class="tab-text">Profile</span>
        </button>
    </nav>

    <transition name="fade">
    <div class="modal-overlay" v-if="showForm">
        <div class="form-header">
            <div class="form-title">{{ isEditing ? 'Edit Entry' : 'New Entry' }}</div>
            <button @click="showForm=false" style="background:transparent; border:none; color:var(--text-primary); font-size:1.5rem;">×</button>
        </div>

        <div style="margin-bottom:2rem; position:relative;" v-if="!isEditing">
            <span class="input-label">Auto-Fill</span>
            <div style="display:flex; gap:12px;">
                <input type="text" class="std-input" v-model="apiTitle" @input="debouncedSearch" placeholder="Title or ID (tt123...)" style="flex:1">
                <input type="number" class="std-input" v-model="apiYear" @input="debouncedSearch" placeholder="Year" style="width:80px">
            </div>
            
            <div class="suggestion-list" v-if="suggestions.length">
                <div class="suggestion-item" v-for="s in suggestions" @click="selectSuggestion(s)">
                    <div class="suggestion-thumb" :style="{backgroundImage: 'url('+s.Poster+')'}"></div>
                    <div class="suggestion-info">
                        <div class="suggestion-title">{{ s.Title }}</div>
                        <div class="suggestion-year">{{ s.Year }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-group"><span class="input-label">Title</span><input class="std-input" v-model="formData.title"></div>
        <div style="display:flex; gap:20px;">
            <div class="input-group" style="flex:1"><span class="input-label">Year</span><input class="std-input" v-model="formData.year"></div>
            <div class="input-group" style="flex:1">
                <span class="input-label">Rating</span>
                <select class="std-input" v-model="formData.rating" ref="ratingInput">
                    <option value="">-</option>
                    <option v-for="r in ratingOpts" :value="r">{{ r }}</option>
                </select>
            </div>
        </div>
        <div class="input-group"><span class="input-label">Date</span><input type="date" class="std-input" v-model="formData.dateWatched"></div>
        <div class="input-group"><span class="input-label">Genre</span><input class="std-input" v-model="formData.genre"></div>
        <div class="input-group"><span class="input-label">Director</span><input class="std-input" v-model="formData.director"></div>
        <div class="input-group"><span class="input-label">Cast (Actors)</span><input class="std-input" v-model="formData.actors"></div>
        <div class="input-group"><span class="input-label">Language</span><input class="std-input" v-model="formData.language"></div>
        <div class="input-group"><span class="input-label">Runtime</span><input class="std-input" v-model="formData.runtime"></div>

        <div class="input-group">
            <span class="input-label">Poster</span>
            <div class="poster-select-row">
                <div class="poster-preview" :class="{selected: selectedPosterIdx === 0}" @click="selectPosterSlot(0)"
                     :style="{backgroundImage: posterSlots[0] ? 'url('+posterSlots[0]+')' : ''}">
                     {{ posterSlots[0] ? '' : 'Org' }}
                </div>
                <div class="poster-preview" v-for="i in 4" :key="i"
                     :class="{selected: selectedPosterIdx === i}" 
                     @click="selectPosterSlot(i)"
                     :style="{backgroundImage: posterSlots[i] ? 'url('+posterSlots[i]+')' : ''}">
                     {{ posterSlots[i] ? '' : '+' }}
                </div>
            </div>
            <div v-if="selectedPosterIdx > 0" style="margin-top:10px;">
                <input type="text" class="std-input" v-model="posterSlots[selectedPosterIdx]" placeholder="Paste Image URL here...">
            </div>
        </div>

        <div class="input-group">
            <span class="input-label">IMDb ID</span>
            <input class="std-input" v-model="formData.movieId" style="opacity:0.6; font-family:monospace;">
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
            <span class="input-label" style="margin:0">Re-watch</span>
            <input type="checkbox" v-model="formData.rewatch">
        </div>

        <button class="btn-save" @click="saveEntry">{{ isEditing ? 'Update Entry' : 'Save Entry' }}</button>
        <button class="btn-delete" v-if="isEditing" @click="confirmDelete(formData.id)">Delete Entry</button>
    </div>
    </transition>

    <transition name="fade">
        <div class="confirm-overlay" v-if="showConfirm">
            <div class="confirm-box">
                <div class="confirm-title">Are you sure?</div>
                <div class="confirm-desc">This action cannot be undone.</div>
                <div class="confirm-actions">
                    <button class="btn-confirm btn-cancel" @click="showConfirm=false">Cancel</button>
                    <button class="btn-confirm btn-danger-confirm" @click="executeDelete">Delete</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // CONSTANTS
            const API_KEY = '9b03b995'; 
            const STORAGE_KEY = 'archive_v3_0_data';
            
            // STATE
            const library = ref([]);
            const view = ref('home');
            const galleryCols = ref(3);
            const searchQuery = ref('');
            const closedGroups = ref([]);
            const showForm = ref(false);
            const isEditing = ref(false);
            const showConfirm = ref(false);
            const deleteTargetId = ref(null);
            const ratingInput = ref(null);
            
            // API Search State (SPLIT)
            const apiTitle = ref('');
            const apiYear = ref('');
            const suggestions = ref([]);
            
            // Form State
            const formData = ref({});
            const posterSlots = ref(['','','','','']); // 0=Org, 1-4=Custom
            const selectedPosterIdx = ref(0);
            
            // Long Press State
            let pressTimer = null;

            // Rating Options
            const ratingOpts = [];
            for(let i=0; i<=5; i+=0.5) ratingOpts.push(Number.isInteger(i) ? i.toString() : i.toFixed(1));

            // LIFECYCLE
            onMounted(() => {
                const data = localStorage.getItem(STORAGE_KEY);
                if(data) {
                    const parsed = JSON.parse(data);
                    // MIGRATION: Fix ratings from "4.0" to "4"
                    library.value = parsed.map(m => {
                        if (m.rating) {
                            const r = parseFloat(m.rating);
                            m.rating = Number.isInteger(r) ? r.toString() : r.toFixed(1);
                        }
                        return m;
                    });
                }
                
                const cols = localStorage.getItem('archive_gallery_cols');
                if(cols) galleryCols.value = parseInt(cols);

                if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-theme');
            });

            // COMPUTED
            const filteredLibrary = computed(() => {
                let d = library.value;
                if(searchQuery.value.trim()) {
                    const q = searchQuery.value.toLowerCase();
                    d = d.filter(m => m.title.toLowerCase().includes(q));
                }
                // Sort by date desc
                return d.sort((a,b) => new Date(b.dateWatched) - new Date(a.dateWatched) || b.id - a.id);
            });

            const groupedLibrary = computed(() => {
                const groups = {};
                filteredLibrary.value.forEach(m => {
                    const d = new Date(m.dateWatched);
                    const key = `${d.getFullYear()}-${d.getMonth()}`;
                    const label = d.toLocaleString('default', { month: 'long', year: 'numeric' });
                    if(!groups[key]) groups[key] = { label, items: [] };
                    groups[key].items.push(m);
                });
                return groups;
            });

            // HELPERS: RED DOT LOGIC FIXED
            const hasMissingInfo = (m) => {
                const isBad = (v) => {
                    if (!v) return true; // Empty string, null, undefined
                    const s = String(v).trim().toLowerCase();
                    return s === '' || s === 'n/a' || s === 'null' || s === 'undefined';
                };
                // Check key fields
                return isBad(m.year) || isBad(m.director) || isBad(m.rating) || isBad(m.poster);
            };

            // METHODS
            const toggleTheme = () => {
                document.body.classList.toggle('light-theme');
                localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
            };

            const adjustGrid = (n) => {
                let v = galleryCols.value - n; 
                if(v < 3) v = 3; if(v > 10) v = 10;
                galleryCols.value = v;
                localStorage.setItem('archive_gallery_cols', v);
            };

            const toggleGroup = (key) => {
                const idx = closedGroups.value.indexOf(key);
                if(idx === -1) closedGroups.value.push(key);
                else closedGroups.value.splice(idx, 1);
            };

            const getHighRes = (url) => {
                if(!url) return '';
                return url.replace(/._V1_.*(\.jpg|\.png|\.jpeg)$/i, "$1");
            };

            const goToProfile = () => {
                window.location.href = 'profile.html';
            };

            // Form Logic
            const openNewForm = () => {
                if(ratingInput.value) ratingInput.value.classList.remove('input-error');

                formData.value = {
                    id: null, title:'', year:'', rating:'', dateWatched: new Date().toISOString().split('T')[0],
                    director:'', genre:'', language:'', runtime:'', actors:'', movieId:'', rewatch: false
                };
                posterSlots.value = ['','','','',''];
                selectedPosterIdx.value = 0;
                apiTitle.value = '';
                apiYear.value = '';
                suggestions.value = [];
                isEditing.value = false;
                showForm.value = true;
            };

            const editEntry = (movie) => {
                if(ratingInput.value) ratingInput.value.classList.remove('input-error');

                formData.value = JSON.parse(JSON.stringify(movie));
                // FIX: Normalize rating to string to match "4" vs "4.0"
                if(formData.value.rating) {
                    let r = parseFloat(formData.value.rating);
                    formData.value.rating = Number.isInteger(r) ? r.toString() : r.toFixed(1);
                }
                
                isEditing.value = true;
                
                posterSlots.value = ['','','','',''];
                posterSlots.value[0] = movie.originalPoster || '';
                
                if(movie.customPosters && Array.isArray(movie.customPosters)) {
                    for(let i=0; i<4; i++) {
                        if(movie.customPosters[i]) posterSlots.value[i+1] = movie.customPosters[i];
                    }
                } else if (movie.poster && movie.poster !== movie.originalPoster) {
                    posterSlots.value[1] = movie.poster; 
                }

                const current = movie.poster;
                const idx = posterSlots.value.findIndex(p => p === current);
                selectedPosterIdx.value = idx > -1 ? idx : 0;

                showForm.value = true;
            };

            const selectPosterSlot = (i) => selectedPosterIdx.value = i;

            const saveEntry = () => {
                if(ratingInput.value) ratingInput.value.classList.remove('input-error');

                if(!formData.value.title) return; 

                // VALIDATION: Rating
                if (formData.value.rating === "" || formData.value.rating === null) {
                    if (ratingInput.value) {
                        ratingInput.value.classList.add('input-error');
                        ratingInput.value.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        if(navigator.vibrate) navigator.vibrate(50);
                    }
                    return; 
                }
                
                const entry = { ...formData.value };
                
                // Final Ensure Correct Rating Format
                let r = parseFloat(entry.rating);
                entry.rating = Number.isInteger(r) ? r.toString() : r.toFixed(1);
                
                entry.originalPoster = posterSlots.value[0];
                entry.customPosters = posterSlots.value.slice(1);
                entry.poster = posterSlots.value[selectedPosterIdx.value] || posterSlots.value[0];
                
                if(isEditing.value) {
                    const idx = library.value.findIndex(x => x.id === entry.id);
                    if(idx > -1) library.value[idx] = entry;
                } else {
                    entry.id = Date.now();
                    library.value.push(entry);
                }
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(library.value));
                showForm.value = false;
            };

            // OMDb Logic with SMART ID DETECTION
            let debounceTimer;
            const debouncedSearch = () => {
                clearTimeout(debounceTimer);
                const inputVal = apiTitle.value.trim();
                
                if(inputVal.length < 3) return;
                
                debounceTimer = setTimeout(async () => {
                    try {
                        let url;
                        // Check for IMDb ID (tt...)
                        const ttMatch = inputVal.match(/tt\d{7,}/);
                        
                        if (ttMatch) {
                             url = `https://www.omdbapi.com/?apikey=${API_KEY}&i=${ttMatch[0]}`;
                        } else {
                             url = `https://www.omdbapi.com/?apikey=${API_KEY}&type=movie&s=${inputVal}`;
                             if(String(apiYear.value).length === 4) {
                                url += `&y=${apiYear.value}`;
                             }
                        }
                        
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        if(data.Response === "True") {
                            // If searching by ID, result is an object, not array
                            if (data.Title && !data.Search) {
                                suggestions.value = [data]; 
                            } else {
                                suggestions.value = data.Search.slice(0,5);
                            }
                        } else {
                            suggestions.value = [];
                        }
                    } catch(e) {}
                }, 500);
            };

            const selectSuggestion = async (s) => {
                try {
                    const res = await fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&i=${s.imdbID}`);
                    const d = await res.json();
                    
                    if(d.Response === "True") {
                        formData.value.title = d.Title;
                        formData.value.year = d.Year;
                        formData.value.director = d.Director;
                        
                        // FIX: Take only first Genre and Language
                        formData.value.genre = d.Genre ? d.Genre.split(',')[0].trim() : '';
                        formData.value.language = d.Language ? d.Language.split(',')[0].trim() : '';
                        
                        formData.value.runtime = d.Runtime;
                        formData.value.movieId = d.imdbID; 
                        formData.value.actors = d.Actors;
                        
                        const hd = getHighRes(d.Poster);
                        posterSlots.value = ['','','','',''];
                        posterSlots.value[0] = (hd !== 'N/A') ? hd : '';
                        
                        formData.value.rewatch = library.value.some(x => x.title === d.Title);
                    }
                    suggestions.value = [];
                } catch(e) {}
            };

            // Deletion Logic
            const startLongPress = (movie) => {
                pressTimer = setTimeout(() => {
                    if(navigator.vibrate) navigator.vibrate(50);
                    confirmDelete(movie.id);
                }, 800);
            };
            const cancelLongPress = () => clearTimeout(pressTimer);

            const confirmDelete = (id) => {
                deleteTargetId.value = id;
                showConfirm.value = true;
            };

            const executeDelete = () => {
                library.value = library.value.filter(x => x.id !== deleteTargetId.value);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(library.value));
                showConfirm.value = false;
                showForm.value = false; 
            };

            return {
                library, view, galleryCols, searchQuery, closedGroups, 
                showForm, isEditing, showConfirm, apiTitle, apiYear, suggestions,
                formData, posterSlots, selectedPosterIdx, ratingOpts,
                groupedLibrary, filteredLibrary, ratingInput,
                toggleTheme, adjustGrid, toggleGroup, getHighRes, goToProfile,
                openNewForm, editEntry, selectPosterSlot, saveEntry,
                debouncedSearch, selectSuggestion,
                startLongPress, cancelLongPress, confirmDelete, executeDelete,
                hasMissingInfo
            };
        }
    }).mount('#app');
</script>

</body>
</html>
