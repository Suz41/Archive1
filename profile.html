<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. APP FRAMEWORK & VARIABLES --- */
        :root {
            /* Colors */
            --bg: #000000;
            --surface: #111111;
            --surface-input: #1c1c1e;
            --border: #333333;
            --text-main: #ffffff;
            --text-muted: #888888;
            --brand: #ffffff;
            --danger: #ff4444;
            
            /* Spacing & Safe Areas */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            
            /* SHARP MINIMALISM: Small Radius Only */
            --radius-md: 6px;
            --radius-sm: 4px;
            
            /* Effects */
            --fade-overlay: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.4) 60%, rgba(0,0,0,1) 100%);
        }

        body.light-theme {
            --bg: #ffffff;
            --surface: #f4f4f4;
            --surface-input: #e5e5ea;
            --border: #e0e0e0;
            --text-main: #000000;
            --text-muted: #666666;
            --brand: #000000;
            --fade-overlay: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 60%, rgba(255,255,255,1) 100%);
        }

        /* --- 2. LAYOUT FRAMEWORK --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100dvh; 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg); color: var(--text-main);
            overflow: hidden; 
        }

        .app-view {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch; 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            background: var(--bg);
            padding-bottom: calc(80px + var(--safe-bottom));
        }

        .app-view::-webkit-scrollbar { width: 0; height: 0; display: none; }
        .picker-list::-webkit-scrollbar { width: 0; }

        /* --- 3. COMPONENTS --- */
        .banner-container { 
            position: relative; width: 100%; height: 260px; 
            background: var(--surface); overflow: hidden; flex-shrink: 0;
        }
        .banner-image { width: 100%; height: 100%; object-fit: cover; opacity: 1; transition: opacity 0.3s; }
        .banner-overlay { position: absolute; inset: 0; background: var(--fade-overlay); pointer-events: none; }
        
        /* NO PILL SHAPE: Square Buttons */
        .nav-btn { 
            position: absolute; top: calc(15px + var(--safe-top)); 
            width: 40px; height: 40px; 
            background: transparent; border: none; 
            z-index: 10; display: flex; align-items: center; justify-content: center;
            border-radius: var(--radius-sm); transition: opacity 0.2s;
        }
        .nav-btn:active { opacity: 0.6; background: rgba(0,0,0,0.2); }
        .btn-back { left: 15px; }
        .btn-settings { right: 15px; }
        .nav-btn svg { width: 22px; height: 22px; stroke: #fff; stroke-width: 2; fill: none; filter: drop-shadow(0 1px 3px rgba(0,0,0,0.5)); }

        .profile-header { padding: 0 20px; position: relative; margin-top: -60px; z-index: 2; margin-bottom: 40px; }
        .header-row { display: flex; align-items: flex-end; gap: 16px; }
        /* Profile Pic: Slight rounding, not circle if you prefer, keeping circle for now as standard identity, but cleaner border */
        .profile-pic { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; background: var(--surface); border: 2px solid var(--bg); box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        .header-text { display: flex; flex-direction: column; justify-content: center; padding-bottom: 30px; }
        .username { font-size: 1.6rem; font-weight: 700; color: var(--text-main); margin: 0; line-height: 1.1; }
        .bio-text { font-size: 0.9rem; color: var(--text-muted); margin: 12px 0 0 0; line-height: 1.4; font-weight: 400; }

        .section-header { display: flex; align-items: center; gap: 15px; padding: 0 20px; margin-bottom: 20px; }
        .section-title-text { font-size: 0.75rem; font-weight: 800; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.12em; opacity: 0.9; }
        .section-divider { flex: 1; height: 1px; background: var(--border); opacity: 0.6; }

        .stats-container { padding: 0 20px; margin-bottom: 40px; }
        .stats-box-border {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            background: transparent; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
            padding: 20px 0;
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .stat-item:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 10%; bottom: 10%; width: 1px; background: var(--border); }
        .stat-val { font-size: 1.35rem; font-weight: 700; color: var(--text-main); line-height: 1.1; margin-bottom: 6px; }
        .stat-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }

        .list-section-title { padding: 0 20px; margin-bottom: 12px; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700; }
        .data-lists-container { display: flex; gap: 20px; padding: 0 20px; margin-bottom: 30px; }
        .data-column { flex: 1; min-width: 0; }
        .content-card { background: transparent; border: 1px solid var(--border); border-radius: var(--radius-md); padding: 4px 0; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .list-row:last-child { border-bottom: none; }
        .list-name { font-size: 0.9rem; color: var(--text-main); font-weight: 500; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .list-count { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
        .lang-card-content { padding: 16px; }
        .lang-text { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; font-weight: 400; }

        .favorites-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 0 12px; margin-bottom: 40px; }
        .fav-slot { 
            aspect-ratio: 2/3; background: var(--surface); border: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; overflow: hidden; border-radius: var(--radius-sm); 
        }
        .fav-poster { width: 100%; height: 100%; object-fit: cover; }
        .fav-placeholder { color: var(--text-muted); font-size: 1.5rem; font-weight: 300; }

        /* --- 4. MINIMAL SETTINGS VIEW --- */
        #view-settings { z-index: 100; transform: translateX(100%); background: var(--bg); }
        #view-settings.active { transform: translateX(0); }
        
        .settings-header {
            padding: calc(15px + var(--safe-top)) 20px 15px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg); position: sticky; top: 0; z-index: 20;
        }
        .settings-title { font-size: 0.9rem; font-weight: 700; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.08em; }
        .btn-close-icon { background: transparent; border: none; padding: 8px; cursor: pointer; color: var(--text-main); display: flex; }
        .btn-close-icon svg { width: 24px; height: 24px; stroke-width: 2; stroke: currentColor; }
        
        /* SHARP BUTTON */
        .btn-save-header { 
            background: var(--text-main); border: none; color: var(--bg); 
            padding: 8px 16px; border-radius: var(--radius-sm); /* No Pill */
            font-weight: 700; font-size: 0.8rem; letter-spacing: 0.02em; text-transform: uppercase;
        }

        .settings-content { padding: 30px 20px; max-width: 600px; margin: 0 auto; width: 100%; }
        .settings-section { margin-bottom: 40px; }
        .section-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px; font-weight: 800; letter-spacing: 0.05em; display: block; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        
        .input-group { margin-bottom: 20px; }
        .input-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.05em;}
        /* SHARP INPUTS */
        input[type="text"], textarea { 
            width: 100%; background: transparent; border: 1px solid var(--border); 
            color: var(--text-main); padding: 12px; border-radius: var(--radius-sm); 
            font-family: inherit; font-size: 0.95rem; display: block; transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--text-main); }
        textarea { resize: none; }

        /* SHARP THEME TOGGLE */
        .theme-row { display: flex; gap: 0; border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; }
        .theme-opt { 
            flex: 1; padding: 12px; cursor: pointer; text-align: center; 
            font-size: 0.8rem; font-weight: 600; color: var(--text-muted); 
            transition: all 0.2s; background: transparent;
        }
        .theme-opt.active { background: var(--text-main); color: var(--bg); }
        
        .cover-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
        .cover-slot { aspect-ratio: 1; background: var(--surface-input); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; border: 2px solid transparent; transition: 0.2s; }
        .cover-slot.selected { border-color: var(--text-main); }
        .cover-slot img { width: 100%; height: 100%; object-fit: cover; }
        .cover-slot-empty { color: var(--text-muted); font-size: 1.5rem; font-weight: 300; }

        .data-row { display: flex; gap: 12px; }
        /* SHARP BUTTONS */
        .data-btn { 
            flex: 1; padding: 14px; background: transparent; border: 1px solid var(--border); 
            color: var(--text-main); border-radius: var(--radius-sm); cursor: pointer; 
            text-align: center; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
            transition: background 0.2s;
        }
        .data-btn:active { background: var(--surface); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: flex-end; flex-direction: column; backdrop-filter: blur(5px); }
        .modal-panel { background: var(--bg); padding: 24px; border-top-left-radius: 16px; border-top-right-radius: 16px; border-top: 1px solid var(--border); max-height: 85vh; display: flex; flex-direction: column; color: var(--text-main); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; flex-shrink: 0; }
        .modal-title { font-weight: 700; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* SHARP TABS */
        .picker-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .picker-tab { 
            padding: 12px 20px; font-size: 0.85rem; font-weight: 600; 
            background: transparent; color: var(--text-muted); border-bottom: 2px solid transparent; cursor: pointer; 
            border-radius: 0; /* No Pill */
        }
        .picker-tab.active { color: var(--text-main); border-bottom-color: var(--text-main); }
        
        .picker-list { overflow-y: auto; flex: 1; padding-bottom: 40px; }
        .picker-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); cursor: pointer; align-items: center; }
        .picker-thumb { width: 40px; height: 60px; background: var(--surface); border-radius: 2px; background-size: cover; flex-shrink: 0; background-position: center; }
        .picker-info { flex: 1; }
        .picker-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; }
        .picker-year { font-size: 0.8rem; color: var(--text-muted); }
        
        .variant-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; overflow-y: auto; }
        .variant-img { 
            width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 2px; cursor: pointer; 
            border: 2px solid transparent; background: var(--surface-input); display: flex; 
            align-items: center; justify-content: center; position: relative;
        }
        .variant-img.selected { border-color: var(--text-main); box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--text-main); }
        .variant-img.locked::after { 
            content: 'ORIG'; position: absolute; bottom: 0; left: 0; right: 0; 
            background: rgba(0,0,0,0.8); color: #fff; font-size: 9px; text-align: center; padding: 2px 0; font-weight: 700;
        }
        .variant-placeholder { font-size: 1.5rem; color: var(--text-muted); }
        
        .action-btn { 
            width: 100%; padding: 16px; margin-bottom: 10px; background: transparent; 
            border: 1px solid var(--border); color: var(--text-main); text-align: left; 
            border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;
        }
        .action-btn.danger { color: var(--danger); border-color: rgba(255, 68, 68, 0.3); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body>

    <div class="app-view" id="view-settings">
        <div class="settings-header">
            <span class="settings-title">Preferences</span>
            <div style="display:flex; gap:16px; align-items:center;">
                <button class="btn-save-header" onclick="saveProfile()">Save</button>
                <button class="btn-close-icon" onclick="toggleSettings()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <span class="section-label">System Appearance</span>
                <div class="theme-row">
                    <div class="theme-opt" id="btn-dark" onclick="setTheme('dark')">Dark</div>
                    <div class="theme-opt" id="btn-light" onclick="setTheme('light')">Light</div>
                </div>
            </div>
            <div class="settings-section">
                <span class="section-label">Identity</span>
                <div class="input-group"><span class="input-label">Display Name</span><input type="text" id="inp-name" placeholder="YOUR NAME"></div>
                <div class="input-group"><span class="input-label">Bio / Tagline</span><textarea id="inp-bio" rows="2" placeholder="Brief description..."></textarea></div>
                <div class="input-group"><span class="input-label">Avatar URL</span><input type="text" id="inp-dp" placeholder="Image link..."></div>
            </div>
            <div class="settings-section">
                <span class="section-label">Banner Image</span>
                <div class="cover-grid" id="cover-grid-content"></div>
                <input type="text" id="inp-cover" placeholder="Or paste custom banner URL..." oninput="updateCoverSlot(this.value)">
            </div>
            <div class="settings-section">
                <span class="section-label">Database</span>
                <div class="data-row">
                    <button class="data-btn" onclick="exportData()">Export Backup</button>
                    <button class="data-btn" onclick="triggerImport()">Import File</button>
                </div>
                <div style="margin-top:10px; font-size:0.75rem; color:var(--text-muted); text-align:center;">
                    Exports are named with date/time for easy tracking.
                </div>
                <input type="file" id="file-import" style="display:none" onchange="handleImport(this)">
            </div>
            <div class="settings-section">
                <span class="section-label">Application</span>
                <button class="action-btn" onclick="window.location.href='about.html'" style="text-align:center;">About App</button>
            </div>
        </div>
    </div>

    <div class="app-view" id="view-main">
        <div class="banner-container">
            <button class="nav-btn btn-back" onclick="window.location.href='index.html'"><svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <button class="nav-btn btn-settings" onclick="toggleSettings()">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
            </button>
            <img src="" id="ui-banner" class="banner-image">
            <div class="banner-overlay"></div>
        </div>

        <div class="profile-header">
            <div class="header-row">
                <img src="" id="ui-dp" class="profile-pic">
                <div class="header-text">
                    <h1 class="username" id="ui-name">User</h1>
                </div>
            </div>
            <p class="bio-text" id="ui-bio"></p>
        </div>

        <div class="section-header">
            <span class="section-title-text">Favorites</span>
            <div class="section-divider"></div>
        </div>
        <div class="favorites-grid" id="ui-favs"></div>

        <div class="section-header">
            <span class="section-title-text">Statistics</span>
            <div class="section-divider"></div>
        </div>
        <div class="stats-container">
            <div class="stats-box-border">
                <div class="stat-item"><span class="stat-val" id="st-count">0</span><span class="stat-lbl">Watched</span></div>
                <div class="stat-item"><span class="stat-val" id="st-time">0h</span><span class="stat-lbl">Runtime</span></div>
                <div class="stat-item"><span class="stat-val" id="st-rate">0.0</span><span class="stat-lbl">Rating</span></div>
            </div>
        </div>

        <div class="data-lists-container">
            <div class="data-column">
                <div class="list-section-title">Top Directors</div>
                <div class="content-card" id="list-directors"></div>
            </div>
            <div class="data-column">
                <div class="list-section-title">Top Actors</div>
                <div class="content-card" id="list-actors"></div>
            </div>
        </div>

        <div class="data-lists-container">
            <div class="data-column">
                <div class="list-section-title">Top Genres</div>
                <div class="content-card" id="list-genres"></div>
            </div>
            <div class="data-column">
                <div class="list-section-title">Languages</div>
                <div class="content-card"><div class="lang-card-content" id="list-langs"></div></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="actionModal">
        <div class="modal-panel">
            <div class="modal-header">
                <span class="modal-title">Options</span>
                <button class="btn-close-icon" onclick="closeAction()"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <button class="action-btn" onclick="triggerEditPoster()">Change Poster</button>
            <button class="action-btn" onclick="triggerReplace()">Replace Movie</button>
            <button class="action-btn danger" onclick="triggerRemove()">Remove</button>
        </div>
    </div>

    <div class="modal-overlay" id="pickerModal">
        <div class="modal-panel" style="height: 85vh;">
            <div class="modal-header">
                <span class="modal-title">Select Movie</span>
                <button class="btn-close-icon" onclick="closePicker()"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="picker-tabs">
                <div class="picker-tab active" id="tab-local" onclick="setPickerMode('local')">LIBRARY</div>
                <div class="picker-tab" id="tab-online" onclick="setPickerMode('online')">ONLINE SEARCH</div>
            </div>
            <input type="text" class="picker-search" id="pickerSearch" placeholder="Type title, ID, or paste IMDb link..." onkeyup="handlePickerSearch(event)" style="margin-bottom:10px;">
            <div class="picker-list" id="picker-list-content"></div>
        </div>
    </div>

    <div class="modal-overlay" id="customizeModal">
        <div class="modal-panel">
            <div class="modal-header">
                <span class="modal-title">Select Poster Version</span>
                <button class="btn-close-icon" onclick="closeCustomize()"><svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="section-label" style="text-align:center; margin-bottom:12px; border:none;">SELECT SLOT (1 ORIGINAL + 4 CUSTOM)</div>
            <div class="variant-grid" id="variant-grid-content"></div>
            
            <div class="input-group" id="custom-url-group">
                <span class="input-label">CUSTOM URL FOR SELECTED SLOT</span>
                <input type="text" id="inp-custom-poster" placeholder="Paste image URL..." oninput="updateSelectedSlot(this.value)">
            </div>
            <button class="action-btn" style="background:var(--text-main); color:var(--bg); text-align:center; font-weight:700; border:none;" onclick="saveCustomFavorite()">CONFIRM SELECTION</button>
        </div>
    </div>

    <script>
        // *** CONFIG ***
        const API_KEY = 'YOUR_KEY_HERE'; // <--- PUT YOUR API KEY HERE
        
        const DB_KEY = 'archive_v3_0_data';
        const PF_KEY = 'archive_user_profile';
        const THEME_KEY = 'archive_theme';

        function setTheme(mode) {
            if (mode === 'light') { document.body.classList.add('light-theme'); localStorage.setItem(THEME_KEY, 'light'); } 
            else { document.body.classList.remove('light-theme'); localStorage.setItem(THEME_KEY, 'dark'); }
            updateThemeBtns();
        }
        function updateThemeBtns() {
            const isLight = document.body.classList.contains('light-theme');
            const d = document.getElementById('btn-dark'), l = document.getElementById('btn-light');
            if (isLight) { l.classList.add('active'); d.classList.remove('active'); } 
            else { d.classList.add('active'); l.classList.remove('active'); }
        }
        if (localStorage.getItem(THEME_KEY) === 'light') document.body.classList.add('light-theme');
        updateThemeBtns();

        let data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let profile = JSON.parse(localStorage.getItem(PF_KEY)) || {
            name: 'Cinemaphile', bio: 'Cinema is subjective',
            cover: 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?auto=format&fit=crop&w=800&q=80',
            dp: 'https://ui-avatars.com/api/?name=User&background=111&color=fff',
            favorites: [null, null, null, null],
            savedCovers: ['', '', '', '']
        };
        // Integrity checks
        if(!profile.favorites) profile.favorites = [null, null, null, null];
        if(!profile.savedCovers || !Array.isArray(profile.savedCovers)) profile.savedCovers = [profile.cover, '', '', ''];

        window.addEventListener('DOMContentLoaded', () => { updateUI(); calcStats(); });

        function updateUI() {
            document.getElementById('ui-name').textContent = profile.name;
            document.getElementById('ui-bio').textContent = profile.bio;
            document.getElementById('ui-banner').src = profile.cover;
            document.getElementById('ui-dp').src = profile.dp;
            document.getElementById('inp-name').value = profile.name;
            document.getElementById('inp-bio').value = profile.bio;
            document.getElementById('inp-dp').value = profile.dp;
            renderCoverSlots();
            renderFavorites();
        }

        let activeCoverSlot = 0;
        function renderCoverSlots() {
            const grid = document.getElementById('cover-grid-content'); grid.innerHTML = '';
            profile.savedCovers.forEach((url, i) => {
                const el = document.createElement('div'); el.className = 'cover-slot';
                if(url === profile.cover) { el.classList.add('selected'); activeCoverSlot = i; }
                el.onclick = () => selectCoverSlot(i);
                if (url && url.length > 5) el.innerHTML = `<img src="${url}">`;
                else el.innerHTML = `<span class="cover-slot-empty">+</span>`;
                grid.appendChild(el);
            });
            document.getElementById('inp-cover').value = profile.savedCovers[activeCoverSlot] || '';
        }
        function selectCoverSlot(index) {
            activeCoverSlot = index;
            const slots = document.querySelectorAll('.cover-slot');
            slots.forEach(s => s.classList.remove('selected'));
            slots[index].classList.add('selected');
            document.getElementById('inp-cover').value = profile.savedCovers[index] || '';
        }
        function updateCoverSlot(url) {
            profile.savedCovers[activeCoverSlot] = url;
            const slots = document.querySelectorAll('.cover-slot');
            if(url.length > 5) slots[activeCoverSlot].innerHTML = `<img src="${url}">`;
            else slots[activeCoverSlot].innerHTML = `<span class="cover-slot-empty">+</span>`;
        }
        function saveProfile() {
            profile.name = document.getElementById('inp-name').value;
            profile.bio = document.getElementById('inp-bio').value;
            profile.dp = document.getElementById('inp-dp').value;
            profile.cover = profile.savedCovers[activeCoverSlot];
            localStorage.setItem(PF_KEY, JSON.stringify(profile));
            updateUI(); toggleSettings();
        }

        let targetSlot = null, activeMovieId = null, selectedPosterUrl = null, tempActionMovie = null, tempMovieTitle = null;
        let tempCustomPosters = ['', '', '', '']; 
        let activeCustomSlotIndex = 0;

        function renderFavorites() {
            const grid = document.getElementById('ui-favs'); grid.innerHTML = '';
            profile.favorites.forEach((favItem, index) => {
                const slot = document.createElement('div'); slot.className = 'fav-slot';
                
                let displayUrl = null;
                let displayTitle = '';
                let movieObj = null;

                if (favItem) {
                    if (typeof favItem === 'object' && favItem.isExternal) {
                        displayUrl = favItem.poster;
                        displayTitle = favItem.title;
                        movieObj = { id: favItem.id, title: favItem.title, poster: favItem.poster, isExternal: true, savedCustoms: favItem.savedCustoms };
                    } else {
                        const validId = typeof favItem === 'object' ? favItem.id : favItem;
                        const customUrl = typeof favItem === 'object' ? favItem.poster : null;
                        const savedCustoms = typeof favItem === 'object' ? favItem.savedCustoms : null;
                        const localMovie = data.find(m => m.id === validId);
                        
                        if (localMovie) {
                            displayUrl = (customUrl || localMovie.poster || '').replace(/._V1_.*(\.jpg|\.png)$/i, "$1");
                            displayTitle = localMovie.title;
                            movieObj = { ...localMovie, savedCustoms: savedCustoms };
                        }
                    }
                }

                if (displayUrl && displayUrl !== 'N/A') {
                    slot.innerHTML = `<img src="${displayUrl}" class="fav-poster">`;
                    slot.onclick = () => openActionMenu(index, movieObj);
                } else if (displayTitle) {
                    slot.innerHTML = `<span class="fav-placeholder">${displayTitle[0]}</span>`;
                    slot.onclick = () => openActionMenu(index, movieObj);
                } else {
                    profile.favorites[index] = null; 
                    slot.innerHTML = '<span class="fav-placeholder">+</span>';
                    slot.onclick = () => openPicker(index);
                }
                grid.appendChild(slot);
            });
        }

        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function hideModal(id) { document.getElementById(id).classList.remove('active'); }

        function openActionMenu(index, movie) { 
            targetSlot = index; 
            tempActionMovie = movie; 
            activeMovieId = movie.id; 
            const existing = profile.favorites[index];
            selectedPosterUrl = (existing && typeof existing === 'object') ? existing.poster : movie.poster; 
            tempCustomPosters = (existing && existing.savedCustoms) ? [...existing.savedCustoms] : ['', '', '', ''];
            showModal('actionModal'); 
        }
        function closeAction() { hideModal('actionModal'); }
        function triggerEditPoster() { closeAction(); openCustomize(tempActionMovie, false); }
        function triggerReplace() { closeAction(); openPicker(targetSlot); }
        function triggerRemove() { profile.favorites[targetSlot] = null; localStorage.setItem(PF_KEY, JSON.stringify(profile)); renderFavorites(); closeAction(); }
        
        /* --- PICKER LOGIC --- */
        let pickerMode = 'local'; 

        function openPicker(slotIndex) { 
            targetSlot = slotIndex; 
            setPickerMode('local');
            document.getElementById('pickerSearch').value = ''; 
            renderPickerList(data); 
            showModal('pickerModal'); 
            document.getElementById('pickerSearch').focus(); 
        }
        function closePicker() { hideModal('pickerModal'); }

        function setPickerMode(mode) {
            pickerMode = mode;
            document.getElementById('tab-local').className = mode === 'local' ? 'picker-tab active' : 'picker-tab';
            document.getElementById('tab-online').className = mode === 'online' ? 'picker-tab active' : 'picker-tab';
            document.getElementById('picker-list-content').innerHTML = '';
            document.getElementById('pickerSearch').value = '';
            if(mode === 'local') renderPickerList(data);
        }

        async function handlePickerSearch(e) {
            const q = document.getElementById('pickerSearch').value.trim();
            if(pickerMode === 'local') {
                renderPickerList(data.filter(m => m.title.toLowerCase().includes(q.toLowerCase())));
            } else {
                if(e.key === 'Enter' && q.length > 2) {
                    document.getElementById('picker-list-content').innerHTML = '<div style="padding:20px;text-align:center;color:#666">Searching...</div>';
                    
                    const imdbMatch = q.match(/(tt\d+)/);
                    let url = '';
                    if (imdbMatch) url = `https://www.omdbapi.com/?apikey=${API_KEY}&i=${imdbMatch[1]}`;
                    else url = `https://www.omdbapi.com/?apikey=${API_KEY}&s=${encodeURIComponent(q)}&type=movie`;

                    try {
                        const res = await fetch(url);
                        const json = await res.json();
                        if (json.Response === "True") {
                            const results = json.Search ? json.Search : [json];
                            renderPickerList(results, true);
                        } else {
                            document.getElementById('picker-list-content').innerHTML = '<div style="padding:20px;text-align:center;color:#666">No results found</div>';
                        }
                    } catch(err) {
                        alert("Error connecting to API");
                    }
                }
            }
        }

        function renderPickerList(list, isOnline = false) {
            const container = document.getElementById('picker-list-content'); container.innerHTML = '';
            list.forEach(m => {
                const item = document.createElement('div'); item.className = 'picker-item';
                const title = isOnline ? m.Title : m.title;
                const year = isOnline ? m.Year : (m.year || '-');
                const poster = isOnline ? m.Poster : m.poster;
                
                const movieObj = isOnline ? 
                    { id: m.imdbID, title: m.Title, poster: m.Poster, isExternal: true, savedCustoms:['','','',''] } : 
                    m;

                item.onclick = () => { closePicker(); openCustomize(movieObj, true); };
                
                const url = (poster && poster !== 'N/A') ? poster : '';
                item.innerHTML = `<div class="picker-thumb" style="background-image:url(${url})"></div><div class="picker-info"><div class="picker-title">${title}</div><div class="picker-year">${year}</div></div>`;
                container.appendChild(item);
            });
        }

        function openCustomize(movie, isNewSelection) {
            activeMovieId = movie.id;
            tempMovieTitle = movie.title;
            tempActionMovie = movie;

            if (isNewSelection) {
                selectedPosterUrl = movie.poster; 
                tempCustomPosters = ['', '', '', ''];
            } else {
                if(!tempCustomPosters || tempCustomPosters.length !== 4) tempCustomPosters = ['', '', '', ''];
            }
            
            renderVariantGrid(movie.originalPoster || movie.poster || '');
            
            if(isNewSelection) selectVariantSlot(0);
            else {
                let foundIndex = 0;
                if (selectedPosterUrl === (movie.originalPoster || movie.poster)) foundIndex = 0;
                else {
                    const customIdx = tempCustomPosters.indexOf(selectedPosterUrl);
                    if(customIdx !== -1) foundIndex = customIdx + 1;
                }
                selectVariantSlot(foundIndex);
            }
            showModal('customizeModal');
        }

        function renderVariantGrid(originalUrl) {
            const grid = document.getElementById('variant-grid-content'); 
            grid.innerHTML = '';
            
            const elOrg = createSlotElement(originalUrl, 0, true);
            grid.appendChild(elOrg);

            tempCustomPosters.forEach((url, i) => {
                const el = createSlotElement(url, i + 1, false);
                grid.appendChild(el);
            });
        }

        function createSlotElement(url, index, isLocked) {
            const el = document.createElement('div'); 
            el.className = 'variant-img';
            if(isLocked) el.classList.add('locked');
            
            el.dataset.idx = index;
            el.onclick = () => selectVariantSlot(index);

            if (url && url !== 'N/A') {
                const img = document.createElement('img'); img.src = url; 
                img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
                el.appendChild(img); 
            } else {
                el.innerHTML = '<span class="variant-placeholder">+</span>';
            }
            return el;
        }

        function selectVariantSlot(index) {
            activeCustomSlotIndex = index;
            document.querySelectorAll('.variant-img').forEach(x => {
                x.classList.remove('selected');
                if(parseInt(x.dataset.idx) === index) x.classList.add('selected');
            });

            const inp = document.getElementById('inp-custom-poster');
            const grp = document.getElementById('custom-url-group');

            if (index === 0) {
                grp.style.opacity = '0.3';
                grp.style.pointerEvents = 'none';
                inp.value = "Original Poster (Locked)";
                selectedPosterUrl = tempActionMovie.originalPoster || tempActionMovie.poster;
            } else {
                grp.style.opacity = '1';
                grp.style.pointerEvents = 'auto';
                const currentVal = tempCustomPosters[index - 1];
                inp.value = currentVal;
                selectedPosterUrl = currentVal; 
            }
        }

        function updateSelectedSlot(val) {
            if(activeCustomSlotIndex === 0) return; 
            tempCustomPosters[activeCustomSlotIndex - 1] = val;
            selectedPosterUrl = val;
            const slots = document.querySelectorAll('.variant-img');
            const target = slots[activeCustomSlotIndex];
            if(val && val.length > 5) target.innerHTML = `<img src="${val}" style="width:100%;height:100%;object-fit:cover">`;
            else target.innerHTML = '<span class="variant-placeholder">+</span>';
        }

        function saveCustomFavorite() { 
            if (!selectedPosterUrl || selectedPosterUrl.length < 5) selectedPosterUrl = tempActionMovie.originalPoster || tempActionMovie.poster;
            profile.favorites[targetSlot] = { 
                id: activeMovieId, 
                poster: selectedPosterUrl,
                title: tempMovieTitle, 
                isExternal: tempActionMovie.isExternal || false,
                savedCustoms: tempCustomPosters 
            }; 
            localStorage.setItem(PF_KEY, JSON.stringify(profile)); 
            renderFavorites(); 
            hideModal('customizeModal'); 
        }
        
        function closeCustomize() { hideModal('customizeModal'); }
        function toggleSettings() { document.getElementById('view-settings').classList.toggle('active'); }
        
        function exportData() { 
            const backup = { library: JSON.parse(localStorage.getItem(DB_KEY)), profile: JSON.parse(localStorage.getItem(PF_KEY)), theme: localStorage.getItem(THEME_KEY) }; 
            const date = new Date();
            const timestamp = date.getFullYear() + "-" + 
                             String(date.getMonth()+1).padStart(2, '0') + "-" + 
                             String(date.getDate()).padStart(2, '0') + "_" + 
                             String(date.getHours()).padStart(2, '0') + "-" + 
                             String(date.getMinutes()).padStart(2, '0');
                             
            const a = document.createElement('a'); 
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup)); 
            a.download = `archive_backup_${timestamp}.json`; 
            document.body.appendChild(a); a.click(); a.remove(); 
        }
        function triggerImport() { document.getElementById('file-import').click(); }
        function handleImport(input) { const reader = new FileReader(); reader.onload = function(e) { try { const json = JSON.parse(e.target.result); if(json.library) localStorage.setItem(DB_KEY, JSON.stringify(json.library)); if(json.profile) localStorage.setItem(PF_KEY, JSON.stringify(json.profile)); if(json.theme) localStorage.setItem(THEME_KEY, json.theme); alert("Imported!"); location.reload(); } catch(err) { alert("Invalid file"); } }; if(input.files[0]) reader.readAsText(input.files[0]); }

        function calcStats() {
            document.getElementById('st-count').textContent = data.length;
            let min=0, rateSum=0, rateCount=0; const genres={};
            data.forEach(m => {
                if(parseInt(m.runtime)) min+=parseInt(m.runtime);
                if(parseFloat(m.rating)>0) { rateSum+=parseFloat(m.rating); rateCount++; }
                if(m.genre) m.genre.split(',').forEach(g => { const c=g.trim(); if(c) genres[c]=(genres[c]||0)+1; });
            });
            document.getElementById('st-time').textContent = Math.round(min/60)+'h';
            document.getElementById('st-rate').textContent = rateCount ? (rateSum/rateCount).toFixed(1) : '0.0';
            
            renderList('list-directors', getTop(data,'director'));
            renderList('list-actors', getTop(data,'actors'));
            const gList = Object.entries(genres).map(([n,c])=>({n,c})).sort((a,b)=>b.c-a.c).slice(0,5);
            renderList('list-genres', gList.length?gList:[]);
            
            // New logic for language list using the generic logic
            const langs = getTop(data,'language').map(i => i.n).join(', ');
            document.getElementById('list-langs').innerHTML = langs ? `<span class="lang-text">${langs}</span>` : '<div class="empty-msg">-</div>';
        }

        // *** NEW RANKING LOGIC ***
        function getTop(arr, key) {
            const stats = {}; 

            arr.forEach(movie => {
                if (!movie[key] || movie[key] === 'N/A') return;
                
                // Get rating, default to 0
                const rating = parseFloat(movie.rating) || 0;

                movie[key].split(',').forEach(rawName => {
                    // Cleanup name
                    const name = rawName.trim().replace(/\s*\(.*\)/, '');
                    if (!name) return;

                    if (!stats[name]) stats[name] = { count: 0, totalRating: 0 };
                    stats[name].count++;
                    stats[name].totalRating += rating;
                });
            });

            return Object.entries(stats)
                .map(([name, d]) => ({
                    n: name, 
                    c: d.count, 
                    avg: d.count > 0 ? (d.totalRating / d.count) : 0 
                }))
                .sort((a, b) => {
                    // 1. Sort by Count (High to Low)
                    if (b.c !== a.c) return b.c - a.c;
                    // 2. Sort by Avg Rating (High to Low) as tie-breaker
                    return b.avg - a.avg;
                })
                .slice(0, 5);
        }

        function renderList(id,l) { const el=document.getElementById(id); el.innerHTML=''; if(!l.length){el.innerHTML='<div class="empty-msg">No data</div>';return;} l.forEach(i=>{ const r=document.createElement('div'); r.className='list-row'; r.innerHTML=`<span class="list-name">${i.n}</span><span class="list-count">${i.c}</span>`; el.appendChild(r); }); }
    </script>
</body>
</html>
