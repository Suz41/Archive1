<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --bg: #000000;
            --surface: #111111;
            --surface-input: #1c1c1e;
            --border: #2a2a2a;
            --text-main: #ffffff;
            --text-muted: #888888;
            --brand: #ffffff;
            --danger: #ff4444;
            --safe-top: env(safe-area-inset-top);
            --radius-md: 12px;
            --radius-sm: 8px;
            --fade-overlay: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,1) 100%);
        }

        body.light-theme {
            --bg: #ffffff;
            --surface: #f4f4f4;
            --surface-input: #e5e5ea;
            --border: #e0e0e0;
            --text-main: #000000;
            --text-muted: #666666;
            --brand: #000000;
            --fade-overlay: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,1) 100%);
        }

        /* --- 2. GLOBAL RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg); color: var(--text-main);
            overflow-x: hidden; padding-bottom: 80px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        button { font-family: inherit; cursor: pointer; }

        /* --- 3. BANNER --- */
        .banner-container { 
            position: relative; width: 100%; height: 260px; 
            background: var(--surface); overflow: hidden;
        }
        .banner-image { 
            width: 100%; height: 100%; object-fit: cover; 
            opacity: 1; transition: opacity 0.3s; 
        }
        .banner-overlay {
            position: absolute; inset: 0;
            background: var(--fade-overlay);
            pointer-events: none;
        }
        
        .nav-btn { 
            position: absolute; top: calc(15px + var(--safe-top)); 
            width: 44px; height: 44px; 
            background: transparent; border: none; 
            z-index: 10; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; 
        }
        .btn-back { left: 15px; }
        .btn-settings { right: 15px; }
        .nav-btn svg { width: 24px; height: 24px; stroke: #fff; stroke-width: 2; fill: none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        /* --- 4. PROFILE HEADER --- */
        .profile-header { 
            padding: 0 20px; position: relative; 
            margin-top: -60px; z-index: 2; margin-bottom: 40px;
        }
        
        .header-row {
            display: flex; align-items: flex-end; gap: 16px;
        }

        .profile-pic { 
            width: 90px; height: 90px; border-radius: 50%; 
            object-fit: cover; background: var(--surface); 
            border: 3px solid var(--bg); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .header-text {
            display: flex; flex-direction: column; justify-content: center; 
            padding-bottom:30px; 
        }

        .username { 
            font-size: 1.6rem; font-weight: 700; color: var(--text-main); 
            margin: 0; line-height: 1.1; 
        }
        
        .bio-text { 
            font-size: 0.9rem; color: var(--text-muted); margin: 12px 0 0 0; 
            line-height: 1.4; font-weight: 400; max-width: 100%;
        }

        /* --- 5. TITLES --- */
        .section-header {
            display: flex; align-items: center; gap: 15px;
            padding: 0 20px; margin-bottom: 20px;
        }
        
        .section-title-text {
            font-size: 0.75rem; 
            font-weight: 800; color: var(--text-main); 
            text-transform: uppercase; letter-spacing: 0.12em; opacity: 0.9;
        }

        .section-divider {
            flex: 1; height: 1px; background: var(--border); opacity: 0.6;
        }

        /* --- 6. STATS BOX --- */
        .stats-container { padding: 0 20px; margin-bottom: 40px; }
        
        .stats-box-border {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px 0;
        }

        .stat-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        .stat-item:not(:last-child)::after {
            content: ''; position: absolute; right: 0; top: 20%; bottom: 20%;
            width: 1px; background: var(--border);
        }
        .stat-val { font-size: 1.35rem; font-weight: 700; color: var(--text-main); line-height: 1.1; margin-bottom: 6px; }
        .stat-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; }

        /* --- 7. LISTS --- */
        .list-section-title {
            padding: 0 20px; margin-bottom: 12px;
            font-size: 0.7rem; color: var(--text-muted); 
            text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700;
            text-align: left;
        }

        .data-lists-container { display: flex; gap: 20px; padding: 0 20px; margin-bottom: 30px; }
        .data-column { flex: 1; min-width: 0; }
        
        .content-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 4px 0;
        }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .list-row:last-child { border-bottom: none; }
        .list-name { font-size: 0.9rem; color: var(--text-main); font-weight: 500; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .list-count { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }
        .lang-card-content { padding: 16px; }
        .lang-text { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; font-weight: 400; display: block; }

        /* --- 8. FAVORITES (UPDATED) --- */
        /* Reduced padding and gap to make posters larger while keeping 4 columns */
        .favorites-grid { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 8px; padding: 0 12px; margin-bottom: 40px; 
        }
        /* Removed border-radius for sharp edges */
        .fav-slot { 
            aspect-ratio: 2/3; background: var(--surface); 
            border-radius: 0; overflow: hidden; border: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; transition: border-color 0.2s; 
        }
        .fav-slot:hover { border-color: var(--text-muted); }
        .fav-poster { width: 100%; height: 100%; object-fit: cover; }
        .fav-placeholder { color: var(--text-muted); font-size: 1.5rem; font-weight: 300; }

        /* --- 9. SETTINGS PAGE --- */
        .settings-page {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: none; flex-direction: column; overflow-y: auto;
            animation: slideIn 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .settings-page.active { display: flex; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .settings-header {
            padding: calc(15px + var(--safe-top)) 20px 15px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: var(--bg); position: sticky; top: 0; z-index: 20;
        }
        .settings-title { font-size: 0.9rem; font-weight: 700; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.08em; }
        
        .btn-close-icon { 
            background: transparent; border: none; padding: 8px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: var(--text-main);
        }
        .btn-close-icon svg { width: 24px; height: 24px; stroke-width: 2; stroke: currentColor; }

        .btn-save-header { 
            background: var(--brand); border: none; color: var(--bg); 
            padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; 
        }

        .settings-content { padding: 20px; max-width: 600px; margin: 0 auto; width: 100%; }
        .settings-section { margin-bottom: 30px; }
        .section-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px; font-weight: 700; letter-spacing: 0.05em; display: block; }
        
        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 0.8rem; color: var(--text-main); font-weight: 500; margin-bottom: 8px; display: block; }
        input[type="text"], textarea { width: 100%; background: var(--surface-input); border: none; color: var(--text-main); padding: 14px 16px; border-radius: 10px; font-family: inherit; font-size: 0.95rem; display: block; }
        input:focus, textarea:focus { outline: 1px solid var(--text-muted); }
        textarea { resize: none; }

        .theme-row { display: flex; gap: 8px; background: var(--surface-input); padding: 4px; border-radius: 12px; }
        .theme-opt { flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; text-align: center; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); transition: all 0.2s; }
        .theme-opt.active { background: var(--surface); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        .cover-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
        .cover-slot { aspect-ratio: 1; background: var(--surface-input); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; border: 2px solid transparent; transition: 0.2s; }
        .cover-slot.selected { border-color: var(--brand); }
        .cover-slot img { width: 100%; height: 100%; object-fit: cover; }
        .cover-slot-empty { color: var(--text-muted); font-size: 1.5rem; font-weight: 300; }

        .data-row { display: flex; gap: 12px; }
        .data-btn { flex: 1; padding: 14px; background: var(--surface-input); border: none; color: var(--text-main); border-radius: 10px; cursor: pointer; text-align: center; font-size: 0.9rem; font-weight: 600; }
        .data-btn:active { background: var(--surface); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: flex-end; flex-direction: column; backdrop-filter: blur(5px); }
        .modal-panel { background: var(--bg); padding: 24px; border-top-left-radius: 20px; border-top-right-radius: 20px; border-top: 1px solid var(--border); max-height: 85vh; overflow-y: auto; color: var(--text-main); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .modal-title { font-weight: 700; font-size: 1rem; text-transform: uppercase; }
        .picker-list { overflow-y: auto; padding-bottom: 40px; }
        .picker-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); cursor: pointer; align-items: center; }
        .picker-thumb { width: 45px; height: 68px; background: var(--surface); border-radius: 4px; background-size: cover; flex-shrink: 0; }
        .picker-info { flex: 1; }
        .picker-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; }
        .picker-year { font-size: 0.8rem; color: var(--text-muted); }
        .variant-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .variant-img { width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .variant-img.selected { border-color: var(--text-main); }
        .action-btn { width: 100%; padding: 16px; margin-bottom: 10px; background: var(--surface); border: 1px solid var(--border); color: var(--text-main); text-align: left; border-radius: 8px; cursor: pointer; }
        .action-btn.danger { color: var(--danger); border-color: rgba(255, 68, 68, 0.3); }

    </style>
</head>
<body>

    <div class="settings-page" id="view-settings">
        <div class="settings-header">
            <span class="settings-title">Preferences</span>
            <div style="display:flex; gap:12px; align-items:center;">
                <button class="btn-save-header" onclick="saveProfile()">Save</button>
                <button class="btn-close-icon" onclick="toggleSettings()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <span class="section-label">Appearance</span>
                <div class="theme-row">
                    <div class="theme-opt" id="btn-dark" onclick="setTheme('dark')">Dark</div>
                    <div class="theme-opt" id="btn-light" onclick="setTheme('light')">Light</div>
                </div>
            </div>
            <div class="settings-section">
                <span class="section-label">Cover Image</span>
                <div class="cover-grid" id="cover-grid-content"></div>
                <input type="text" id="inp-cover" placeholder="Paste URL for selected slot..." oninput="updateCoverSlot(this.value)">
            </div>
            <div class="settings-section">
                <span class="section-label">Profile Identity</span>
                <div class="input-group"><span class="input-label">Avatar URL</span><input type="text" id="inp-dp" placeholder="https://..."></div>
                <div class="input-group"><span class="input-label">Display Name</span><input type="text" id="inp-name" placeholder="Name"></div>
                <div class="input-group"><span class="input-label">Bio</span><textarea id="inp-bio" rows="3" placeholder="Tell us about yourself..."></textarea></div>
            </div>
            <div class="settings-section">
                <span class="section-label">Data Management</span>
                <div class="data-row"><button class="data-btn" onclick="exportData()">Export Data</button><button class="data-btn" onclick="triggerImport()">Import Data</button></div>
                <input type="file" id="file-import" style="display:none" onchange="handleImport(this)">
            </div>
        </div>
    </div>

    <div class="banner-container">
        <button class="nav-btn btn-back" onclick="window.location.href='index.html'"><svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        <button class="nav-btn btn-settings" onclick="toggleSettings()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line>
                <line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line>
                <line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line>
            </svg>
        </button>
        <img src="" id="ui-banner" class="banner-image">
        <div class="banner-overlay"></div>
    </div>

    <div class="profile-header">
        <div class="header-row">
            <img src="" id="ui-dp" class="profile-pic">
            <div class="header-text">
                <h1 class="username" id="ui-name">User</h1>
            </div>
        </div>
        <p class="bio-text" id="ui-bio"></p>
    </div>

    <div class="section-header">
        <span class="section-title-text">Favorites</span>
        <div class="section-divider"></div>
    </div>
    <div class="favorites-grid" id="ui-favs"></div>

    <div class="section-header">
        <span class="section-title-text">Statistics</span>
        <div class="section-divider"></div>
    </div>
    <div class="stats-container">
        <div class="stats-box-border">
            <div class="stat-item"><span class="stat-val" id="st-count">0</span><span class="stat-lbl">Watched</span></div>
            <div class="stat-item"><span class="stat-val" id="st-time">0h</span><span class="stat-lbl">Runtime</span></div>
            <div class="stat-item"><span class="stat-val" id="st-rate">0.0</span><span class="stat-lbl">Rating</span></div>
        </div>
    </div>

    <div class="data-lists-container">
        <div class="data-column">
            <div class="list-section-title">Top Directors</div>
            <div class="content-card" id="list-directors"></div>
        </div>
        <div class="data-column">
            <div class="list-section-title">Top Actors</div>
            <div class="content-card" id="list-actors"></div>
        </div>
    </div>

    <div class="data-lists-container">
        <div class="data-column">
            <div class="list-section-title">Top Genres</div>
            <div class="content-card" id="list-genres"></div>
        </div>
        <div class="data-column">
            <div class="list-section-title">Languages</div>
            <div class="content-card"><div class="lang-card-content" id="list-langs"></div></div>
        </div>
    </div>

    <div class="modal-overlay" id="actionModal">
        <div class="modal-panel">
            <div class="modal-header">
                <span class="modal-title">Options</span>
                <button class="btn-close-icon" onclick="closeAction()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <button class="action-btn" onclick="triggerEditPoster()">Change Poster</button>
            <button class="action-btn" onclick="triggerReplace()">Replace Movie</button>
            <button class="action-btn danger" onclick="triggerRemove()">Remove</button>
        </div>
    </div>

    <div class="modal-overlay" id="pickerModal">
        <div class="modal-panel" style="height: 85vh;">
            <div class="modal-header">
                <span class="modal-title">Select Movie</span>
                <button class="btn-close-icon" onclick="closePicker()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <input type="text" class="picker-search" id="pickerSearch" placeholder="Search..." oninput="handlePickerSearch()">
            <div class="picker-list" id="picker-list-content"></div>
        </div>
    </div>

    <div class="modal-overlay" id="customizeModal">
        <div class="modal-panel">
            <div class="modal-header">
                <span class="modal-title">Select Version</span>
                <button class="btn-close-icon" onclick="closeCustomize()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="variant-grid" id="variant-grid-content"></div>
            <button class="action-btn" style="background:var(--brand); color:var(--bg); text-align:center; font-weight:700;" onclick="saveCustomFavorite()">Confirm</button>
        </div>
    </div>

    <script>
        const DB_KEY = 'archive_v3_0_data';
        const PF_KEY = 'archive_user_profile';
        const THEME_KEY = 'archive_theme';

        function setTheme(mode) {
            if (mode === 'light') { document.body.classList.add('light-theme'); localStorage.setItem(THEME_KEY, 'light'); } 
            else { document.body.classList.remove('light-theme'); localStorage.setItem(THEME_KEY, 'dark'); }
            updateThemeBtns();
        }
        function updateThemeBtns() {
            const isLight = document.body.classList.contains('light-theme');
            const d = document.getElementById('btn-dark'), l = document.getElementById('btn-light');
            if (isLight) { l.classList.add('active'); d.classList.remove('active'); } 
            else { d.classList.add('active'); l.classList.remove('active'); }
        }
        if (localStorage.getItem(THEME_KEY) === 'light') document.body.classList.add('light-theme');
        updateThemeBtns();

        let data = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let profile = JSON.parse(localStorage.getItem(PF_KEY)) || {
            name: 'Cinemaphile', bio: 'Cinema is subjective',
            cover: 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?auto=format&fit=crop&w=800&q=80',
            dp: 'https://ui-avatars.com/api/?name=User&background=111&color=fff',
            favorites: [null, null, null, null],
            savedCovers: ['', '', '', '']
        };
        if(!profile.favorites) profile.favorites = [null, null, null, null];
        if(!profile.savedCovers || !Array.isArray(profile.savedCovers)) profile.savedCovers = [profile.cover, '', '', ''];

        window.addEventListener('DOMContentLoaded', () => { updateUI(); calcStats(); });

        function updateUI() {
            document.getElementById('ui-name').textContent = profile.name;
            document.getElementById('ui-bio').textContent = profile.bio;
            document.getElementById('ui-banner').src = profile.cover;
            document.getElementById('ui-dp').src = profile.dp;
            document.getElementById('inp-name').value = profile.name;
            document.getElementById('inp-bio').value = profile.bio;
            document.getElementById('inp-dp').value = profile.dp;
            renderCoverSlots();
            renderFavorites();
        }

        let activeCoverSlot = 0;
        function renderCoverSlots() {
            const grid = document.getElementById('cover-grid-content'); grid.innerHTML = '';
            profile.savedCovers.forEach((url, i) => {
                const el = document.createElement('div'); el.className = 'cover-slot';
                if(url === profile.cover) { el.classList.add('selected'); activeCoverSlot = i; }
                el.onclick = () => selectCoverSlot(i);
                if (url && url.length > 5) el.innerHTML = `<img src="${url}">`;
                else el.innerHTML = `<span class="cover-slot-empty">+</span>`;
                grid.appendChild(el);
            });
            document.getElementById('inp-cover').value = profile.savedCovers[activeCoverSlot] || '';
        }
        function selectCoverSlot(index) {
            activeCoverSlot = index;
            const slots = document.querySelectorAll('.cover-slot');
            slots.forEach(s => s.classList.remove('selected'));
            slots[index].classList.add('selected');
            document.getElementById('inp-cover').value = profile.savedCovers[index] || '';
        }
        function updateCoverSlot(url) {
            profile.savedCovers[activeCoverSlot] = url;
            const slots = document.querySelectorAll('.cover-slot');
            if(url.length > 5) slots[activeCoverSlot].innerHTML = `<img src="${url}">`;
            else slots[activeCoverSlot].innerHTML = `<span class="cover-slot-empty">+</span>`;
        }
        function saveProfile() {
            profile.name = document.getElementById('inp-name').value;
            profile.bio = document.getElementById('inp-bio').value;
            profile.dp = document.getElementById('inp-dp').value;
            profile.cover = profile.savedCovers[activeCoverSlot];
            localStorage.setItem(PF_KEY, JSON.stringify(profile));
            updateUI(); toggleSettings();
        }

        let targetSlot = null, activeMovieId = null, selectedPosterUrl = null, tempActionMovie = null;
        function renderFavorites() {
            const grid = document.getElementById('ui-favs'); grid.innerHTML = '';
            profile.favorites.forEach((favItem, index) => {
                const slot = document.createElement('div'); slot.className = 'fav-slot';
                let validId = favItem && typeof favItem === 'object' ? favItem.id : favItem;
                let customUrl = favItem && typeof favItem === 'object' ? favItem.poster : null;
                if (validId) {
                    const movie = data.find(m => m.id === validId);
                    if (movie) {
                        const url = (customUrl || movie.poster || '').replace(/._V1_.*(\.jpg|\.png)$/i, "$1");
                        if(url && url !== 'N/A') slot.innerHTML = `<img src="${url}" class="fav-poster">`;
                        else slot.innerHTML = `<span class="fav-placeholder">${movie.title[0]}</span>`;
                        slot.onclick = () => openActionMenu(index, movie);
                    } else { profile.favorites[index] = null; slot.innerHTML = '<span class="fav-placeholder">+</span>'; slot.onclick = () => openPicker(index); }
                } else { slot.innerHTML = '<span class="fav-placeholder">+</span>'; slot.onclick = () => openPicker(index); }
                grid.appendChild(slot);
            });
        }

        function openActionMenu(index, movie) { targetSlot = index; tempActionMovie = movie; activeMovieId = movie.id; selectedPosterUrl = (profile.favorites[index] && typeof profile.favorites[index] === 'object') ? profile.favorites[index].poster : movie.poster; document.getElementById('actionModal').style.display = 'flex'; }
        function closeAction() { document.getElementById('actionModal').style.display = 'none'; }
        function triggerEditPoster() { closeAction(); openCustomize(tempActionMovie, false); }
        function triggerReplace() { closeAction(); openPicker(targetSlot); }
        function triggerRemove() { profile.favorites[targetSlot] = null; localStorage.setItem(PF_KEY, JSON.stringify(profile)); renderFavorites(); closeAction(); }
        function openPicker(slotIndex) { targetSlot = slotIndex; document.getElementById('pickerSearch').value = ''; renderPickerList(data); document.getElementById('pickerModal').style.display = 'flex'; document.getElementById('pickerSearch').focus(); }
        function handlePickerSearch() { renderPickerList(data.filter(m => m.title.toLowerCase().includes(document.getElementById('pickerSearch').value.toLowerCase()))); }
        function renderPickerList(list) {
            const container = document.getElementById('picker-list-content'); container.innerHTML = '';
            [...list].sort((a,b) => new Date(b.dateWatched) - new Date(a.dateWatched)).forEach(m => {
                const item = document.createElement('div'); item.className = 'picker-item';
                item.onclick = () => { closePicker(); openCustomize(m, true); };
                const url = (m.poster && m.poster !== 'N/A') ? m.poster : '';
                item.innerHTML = `<div class="picker-thumb" style="background-image:url(${url})"></div><div class="picker-info"><div class="picker-title">${m.title}</div><div class="picker-year">${m.year||'-'}</div></div>`;
                container.appendChild(item);
            });
        }
        function openCustomize(movie, isNewSelection) {
            activeMovieId = movie.id;
            if (isNewSelection) selectedPosterUrl = movie.poster; 
            const slots = []; slots[0] = movie.originalPoster || movie.poster || '';
            const customs = movie.customPosters || []; for(let i=0; i<4; i++) slots[i+1] = customs[i] || '';
            const grid = document.getElementById('variant-grid-content'); grid.innerHTML = '';
            slots.forEach((url, i) => {
                const el = document.createElement('div'); el.className = 'variant-img';
                if(url === selectedPosterUrl && url !== '') el.classList.add('selected');
                if (url && url !== 'N/A') {
                    const img = document.createElement('img'); img.src = url; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
                    el.appendChild(img); el.onclick = () => { selectedPosterUrl = url; document.querySelectorAll('.variant-img').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); };
                } 
                grid.appendChild(el);
            });
            document.getElementById('customizeModal').style.display = 'flex';
        }
        function saveCustomFavorite() { profile.favorites[targetSlot] = { id: activeMovieId, poster: selectedPosterUrl }; localStorage.setItem(PF_KEY, JSON.stringify(profile)); renderFavorites(); document.getElementById('customizeModal').style.display = 'none'; }
        function closeCustomize() { document.getElementById('customizeModal').style.display = 'none'; }
        function closePicker() { document.getElementById('pickerModal').style.display = 'none'; }
        function toggleSettings() { const el=document.getElementById('view-settings'); el.classList.toggle('active'); }
        function exportData() { const backup = { library: JSON.parse(localStorage.getItem(DB_KEY)), profile: JSON.parse(localStorage.getItem(PF_KEY)), theme: localStorage.getItem(THEME_KEY) }; const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup)); a.download = "archive_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
        function triggerImport() { document.getElementById('file-import').click(); }
        function handleImport(input) { const reader = new FileReader(); reader.onload = function(e) { try { const json = JSON.parse(e.target.result); if(json.library) localStorage.setItem(DB_KEY, JSON.stringify(json.library)); if(json.profile) localStorage.setItem(PF_KEY, JSON.stringify(json.profile)); if(json.theme) localStorage.setItem(THEME_KEY, json.theme); alert("Imported!"); location.reload(); } catch(err) { alert("Invalid file"); } }; if(input.files[0]) reader.readAsText(input.files[0]); }

        function calcStats() {
            document.getElementById('st-count').textContent = data.length;
            let min=0, rateSum=0, rateCount=0; const genres={};
            data.forEach(m => {
                if(parseInt(m.runtime)) min+=parseInt(m.runtime);
                if(parseFloat(m.rating)>0) { rateSum+=parseFloat(m.rating); rateCount++; }
                if(m.genre) m.genre.split(',').forEach(g => { const c=g.trim(); if(c) genres[c]=(genres[c]||0)+1; });
            });
            document.getElementById('st-time').textContent = Math.round(min/60)+'h';
            document.getElementById('st-rate').textContent = rateCount ? (rateSum/rateCount).toFixed(1) : '0.0';
            
            renderList('list-directors', getTop(data,'director'));
            renderList('list-actors', getTop(data,'actors'));
            const gList = Object.entries(genres).map(([n,c])=>({n,c})).sort((a,b)=>b.c-a.c).slice(0,5);
            renderList('list-genres', gList.length?gList:[]);
            
            const langs = getTop(data,'language').map(i => i.n).join(', ');
            document.getElementById('list-langs').innerHTML = langs ? `<span class="lang-text">${langs}</span>` : '<div class="empty-msg">-</div>';
        }
        function getTop(arr,k) { const c={}; arr.forEach(i=>{ if(!i[k]||i[k]==='N/A')return; i[k].split(',').forEach(v=>{ const x=v.trim().replace(/\s*\(.*\)/,''); if(x)c[x]=(c[x]||0)+1; }); }); return Object.entries(c).map(([n,c])=>({n,c})).sort((a,b)=>b.c-a.c).slice(0,5); }
        function renderList(id,l) { const el=document.getElementById(id); el.innerHTML=''; if(!l.length){el.innerHTML='<div class="empty-msg">No data</div>';return;} l.forEach(i=>{ const r=document.createElement('div'); r.className='list-row'; r.innerHTML=`<span class="list-name">${i.n}</span><span class="list-count">${i.c}</span>`; el.appendChild(r); }); }
    </script>
</body>
</html>
